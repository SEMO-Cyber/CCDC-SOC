<form version="1.1">
  <label>Network Threat Detection</label>
  <description>All network-layer detections consolidated - Zeek, Suricata, DNS, firewall, data exfil</description>

  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_token">
      <label>Time Range</label>
      <default>
        <earliest>-4h@m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="text" token="src_filter">
      <label>Source IP Filter</label>
      <default>*</default>
    </input>
    <input type="text" token="dest_filter">
      <label>Destination IP Filter</label>
      <default>*</default>
    </input>
  </fieldset>

  <!-- ============================================================ -->
  <!-- Row 1: 4 KPI Cards -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <single>
        <title>Zeek Detections</title>
        <search>
          <query>
index=network sourcetype=zeek:notice id.orig_h=$src_filter$ id.resp_h=$dest_filter$
| stats count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[10,50]</option>
        <option name="underLabel">Notice Events</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Suricata Alerts</title>
        <search>
          <query>
index=linux sourcetype=suricata:fast
| rex field=_raw "\{(?&lt;proto&gt;\w+)\}\s*(?&lt;src&gt;[\d.]+):(?&lt;sport&gt;\d+)\s*-&gt;\s*(?&lt;dst&gt;[\d.]+):(?&lt;dport&gt;\d+)"
| where (src LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (dst LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| stats count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[5,25]</option>
        <option name="underLabel">IDS Alerts</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Unique External IPs</title>
        <search>
          <query>
index=network sourcetype=zeek:conn id.orig_h=$src_filter$ id.resp_h=$dest_filter$
| where NOT cidrmatch("192.168.0.0/16", id.orig_h) OR NOT cidrmatch("192.168.0.0/16", id.resp_h)
| eval external_ip=if(cidrmatch("192.168.0.0/16", id.orig_h), id.resp_h, id.orig_h)
| stats dc(external_ip) as count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Distinct IPs Seen</option>
        <option name="useColors">0</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Data Transferred</title>
        <search>
          <query>
index=network sourcetype=zeek:conn id.orig_h=$src_filter$ id.resp_h=$dest_filter$
| stats sum(orig_bytes) as out, sum(resp_bytes) as in
| eval total_GB=round((out+in)/1073741824, 2)
| fields total_GB
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="underLabel">Total GB</option>
        <option name="useColors">0</option>
      </single>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 2: C2 Framework Detections -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>C2 Framework Detections</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:notice (note="*C2*" OR note="*Malware*" OR note="*Suspicious*" OR note="*Beacon*" OR note="*Sliver*" OR note="*Mythic*" OR note="*Cobalt*" OR note="*Empire*" OR note="*Metasploit*")
| where (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (id.resp_h LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| stats count as beacon_count, min(_time) as first_seen, max(_time) as last_seen, values(msg) as details by note, id.orig_h, id.resp_h, id.resp_p
| eval duration=round((last_seen-first_seen)/60, 1)
| eval first_seen=strftime(first_seen, "%H:%M:%S"), last_seen=strftime(last_seen, "%H:%M:%S")
| sort -beacon_count
| rename note as "Detection", id.orig_h as "Infected Host", id.resp_h as "C2 Server", id.resp_p as "Port", beacon_count as "Beacons", duration as "Duration (min)", details as "Details"
| head 30
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Detection">
          <colorPalette type="map">{"C2_TLS_Fingerprint":#DC4E41,"Malware_Callback":#DC4E41,"C2_Beacon_Detected":#DC4E41,"Suspicious_TLS_Certificate":#F1813F,"Suspicious_SSH_Connection":#F1813F}</colorPalette>
        </format>
        <format type="color" field="Beacons">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#F8BE34"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 3: IDS Alert Details + Timeline -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Suricata IDS Alert Details</title>
      <table>
        <search>
          <query>
index=linux sourcetype=suricata:fast
| rex field=_raw "\[\*\*\]\s*\[(?&lt;sid&gt;[\d:]+)\]\s*(?&lt;alert_msg&gt;[^\[]+)\[\*\*\]"
| rex field=_raw "\[Priority:\s*(?&lt;priority&gt;\d+)\]"
| rex field=_raw "\{(?&lt;proto&gt;\w+)\}\s*(?&lt;src&gt;[\d.]+):(?&lt;sport&gt;\d+)\s*-&gt;\s*(?&lt;dst&gt;[\d.]+):(?&lt;dport&gt;\d+)"
| where (src LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (dst LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| eval severity=case(priority=="1", "CRITICAL", priority=="2", "HIGH", priority=="3", "MEDIUM", 1=1, "LOW")
| table _time, severity, alert_msg, src, sport, dst, dport, proto
| sort -_time
| rename severity as "Severity", alert_msg as "Alert", src as "Source", sport as "SPort", dst as "Dest", dport as "DPort", proto as "Proto"
| head 50
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"CRITICAL":#DC4E41,"HIGH":#F1813F,"MEDIUM":#F8BE34,"LOW":#53A051}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>IDS Alert Timeline</title>
      <chart>
        <search>
          <query>
index=linux sourcetype=suricata:fast
| rex field=_raw "\[Priority:\s*(?&lt;priority&gt;\d+)\]"
| rex field=_raw "\{(?&lt;proto&gt;\w+)\}\s*(?&lt;src&gt;[\d.]+):(?&lt;sport&gt;\d+)\s*-&gt;\s*(?&lt;dst&gt;[\d.]+):(?&lt;dport&gt;\d+)"
| where (src LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (dst LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| eval severity=case(priority=="1", "Critical", priority=="2", "High", priority=="3", "Medium", 1=1, "Low")
| timechart span=5m count by severity
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.fieldColors">{"Critical":#DC4E41,"High":#F1813F,"Medium":#F8BE34,"Low":#53A051}</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 4: DNS Tunneling Detection + NXDOMAIN Spikes -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>DNS Tunneling Detection</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:dns
| where isnotnull(query)
| eval query_len=len(query)
| rex field=query "(?&lt;subdomain&gt;[^.]+)\.(?&lt;domain&gt;.+)"
| stats count as queries, avg(query_len) as avg_length, dc(subdomain) as unique_subdomains, values(qtype_name) as qtypes by id.orig_h, domain
| where queries &gt; 20 AND (avg_length &gt; 40 OR unique_subdomains &gt; 15)
| eval risk=case(
    avg_length &gt; 60 AND unique_subdomains &gt; 50, "HIGH",
    avg_length &gt; 40 OR unique_subdomains &gt; 25, "MEDIUM",
    1=1, "LOW"
)
| eval avg_length=round(avg_length, 1)
| sort -unique_subdomains
| rename id.orig_h as "Source", domain as "Domain", queries as "Queries", avg_length as "Avg Length", unique_subdomains as "Unique Subdomains", risk as "Risk"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Risk">
          <colorPalette type="map">{"HIGH":#DC4E41,"MEDIUM":#F8BE34,"LOW":#53A051}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>NXDOMAIN Spikes</title>
      <chart>
        <search>
          <query>
index=network sourcetype=zeek:dns rcode_name="NXDOMAIN"
| timechart span=5m count by id.orig_h limit=10
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 5: DNS and HTTP Domain Overview -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Top Queried DNS Domains</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:dns
| where isnotnull(query) AND (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*")
| rex field=query "(?&lt;base_domain&gt;[^.]+\.[^.]+)$"
| where isnotnull(base_domain)
| stats count as queries, dc(id.orig_h) as clients, values(qtype_name) as query_types, values(rcode_name) as response_codes by base_domain
| append [
    search index=linux sourcetype=technitium:syslog
    | rex field=_raw "client:\s*(?&lt;client_ip&gt;[\d.]+)"
    | rex field=_raw "query:\s*(?&lt;query_domain&gt;[^\s;]+)"
    | where isnotnull(query_domain) AND (client_ip LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*")
    | rex field=query_domain "(?&lt;base_domain&gt;[^.]+\.[^.]+)$"
    | where isnotnull(base_domain)
    | stats count as queries, dc(client_ip) as clients by base_domain
    | eval query_types="N/A", response_codes="N/A"
]
| stats sum(queries) as queries, sum(clients) as clients, values(query_types) as query_types, values(response_codes) as response_codes by base_domain
| sort -queries
| rename base_domain as "Domain", queries as "Queries", clients as "Clients", query_types as "Query Types", response_codes as "Response Codes"
| head 25
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Queries">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#53A051"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="color" field="Clients">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#53A051"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Top HTTP Hosts Accessed</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:http
| where isnotnull(domain_host) AND (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (id.resp_h LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| stats count as requests, dc(id.orig_h) as clients, dc(uri) as unique_uris, values(method) as methods by domain_host
| sort -requests
| rename domain_host as "HTTP Host", requests as "Requests", clients as "Clients", unique_uris as "Unique URIs", methods as "Methods"
| head 25
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Requests">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#53A051"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="color" field="Clients">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#53A051"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 6: Domain Activity Timelines -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>DNS Query Volume by Top Domains</title>
      <chart>
        <search>
          <query>
index=network sourcetype=zeek:dns
| where isnotnull(query) AND (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*")
| rex field=query "(?&lt;base_domain&gt;[^.]+\.[^.]+)$"
| where isnotnull(base_domain)
| timechart span=5m count by base_domain limit=10
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>HTTP Host Access Timeline</title>
      <chart>
        <search>
          <query>
index=network sourcetype=zeek:http
| where isnotnull(domain_host) AND (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*")
| timechart span=5m count by domain_host limit=10
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 7: DNS Anomaly Detection -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Single-Client Domains (Possible C2)</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:dns
| where isnotnull(query) AND (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*")
| rex field=query "(?&lt;base_domain&gt;[^.]+\.[^.]+)$"
| where isnotnull(base_domain)
| stats count as queries, dc(id.orig_h) as client_count, values(id.orig_h) as clients, dc(query) as unique_subdomains by base_domain
| where client_count==1 AND queries&gt;=3
| eval risk=case(
    queries&gt;=50, "HIGH",
    queries&gt;=15, "MEDIUM",
    1=1, "LOW"
)
| sort -queries
| rename base_domain as "Domain", queries as "Queries", client_count as "Clients", clients as "Client IP", unique_subdomains as "Unique Subdomains", risk as "Risk"
| head 25
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Risk">
          <colorPalette type="map">{"HIGH":#DC4E41,"MEDIUM":#F8BE34,"LOW":#53A051}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>High NXDOMAIN Rate Domains</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:dns
| where isnotnull(query) AND (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*")
| rex field=query "(?&lt;base_domain&gt;[^.]+\.[^.]+)$"
| where isnotnull(base_domain)
| stats count as total_queries, sum(eval(if(rcode_name=="NXDOMAIN",1,0))) as nxdomain_count, dc(query) as unique_subdomains, dc(id.orig_h) as clients by base_domain
| eval fail_rate=round(nxdomain_count/total_queries*100, 1)
| where fail_rate&gt;=50 AND total_queries&gt;=5
| eval risk=case(
    fail_rate&gt;=90 AND unique_subdomains&gt;=10, "CRITICAL (DGA)",
    fail_rate&gt;=80, "HIGH",
    1=1, "MEDIUM"
)
| sort -fail_rate -total_queries
| rename base_domain as "Domain", total_queries as "Total Queries", nxdomain_count as "NXDOMAIN", fail_rate as "Fail Rate %", unique_subdomains as "Unique Subdomains", clients as "Clients", risk as "Risk"
| head 25
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Risk">
          <colorPalette type="map">{"CRITICAL (DGA)":#DC4E41,"HIGH":#F1813F,"MEDIUM":#F8BE34}</colorPalette>
        </format>
        <format type="color" field="Fail Rate %">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#F8BE34"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 8: Port Scanners + Connection State Analysis -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Port Scan Detection</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:conn conn_state IN ("REJ", "RSTO", "S0", "RSTOS0")
| where (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (id.resp_h LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| stats dc(id.resp_p) as unique_ports, dc(id.resp_h) as unique_hosts, count as attempts by id.orig_h
| eval scan_type=case(
    unique_ports &gt; 50 AND unique_hosts &lt;= 3, "Vertical (Port Sweep)",
    unique_hosts &gt; 10 AND unique_ports &lt;= 5, "Horizontal (Host Sweep)",
    unique_ports &gt; 20 AND unique_hosts &gt; 10, "Network Sweep",
    1=1, "Probing"
)
| where unique_ports &gt; 15 OR unique_hosts &gt; 5
| sort -attempts
| rename id.orig_h as "Scanner", unique_ports as "Unique Ports", unique_hosts as "Unique Hosts", attempts as "Attempts", scan_type as "Scan Type"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Scan Type">
          <colorPalette type="map">{"Vertical (Port Sweep)":#DC4E41,"Horizontal (Host Sweep)":#F1813F,"Network Sweep":#DC4E41,"Probing":#F8BE34}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>Connection State Analysis</title>
      <chart>
        <search>
          <query>
index=network sourcetype=zeek:conn conn_state IN ("REJ", "RSTO", "S0", "RSTOS0", "SH", "SHR")
| timechart span=5m count by conn_state
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 9: Firewall Block Details + Block Timeline -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Firewall Block Details</title>
      <table>
        <search>
          <query>
index=linux sourcetype=iptables
| stats count as blocks, dc(dest_port) as unique_ports, values(protocol) as protocols by src_ip, ipt_chain, host
| sort -blocks
| rename src_ip as "Source IP", ipt_chain as "Chain", host as "Firewall Host", blocks as "Blocks", unique_ports as "Unique Ports", protocols as "Protocols"
| head 30
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Blocks">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#53A051"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Firewall Block Timeline</title>
      <chart>
        <search>
          <query>
index=linux sourcetype=iptables
| timechart span=5m count by ipt_chain limit=10
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 10: Large Outbound Transfers + Suspicious HTTP -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Large Outbound Transfers (Data Exfil Indicators)</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:conn
| where isnotnull(orig_bytes) AND orig_bytes &gt; 10485760
| eval orig_MB=round(orig_bytes/1048576, 2), resp_MB=round(resp_bytes/1048576, 2)
| eval ratio=if(resp_bytes&gt;0, round(orig_bytes/resp_bytes, 1), "N/A")
| table _time, id.orig_h, id.resp_h, id.resp_p, service, orig_MB, resp_MB, ratio, duration
| sort -orig_MB
| rename id.orig_h as "Source", id.resp_h as "Destination", id.resp_p as "Port", orig_MB as "Sent (MB)", resp_MB as "Received (MB)", ratio as "Out/In Ratio", duration as "Duration (s)"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Sent (MB)">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#F8BE34"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Suspicious HTTP Activity</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:http
| where (user_agent IN ("curl*", "wget*", "python*", "Go-http*", "PowerShell*", "Java*") OR status_code &gt;= 400)
| eval flag=case(
    match(user_agent, "^(curl|wget|python|Go-http|PowerShell|Java)"), "Suspicious UA",
    status_code &gt;= 500, "Server Error",
    status_code &gt;= 400, "Client Error",
    1=1, "Other"
)
| stats count, values(method) as methods, values(user_agent) as user_agents by id.orig_h, id.resp_h, flag
| sort -count
| rename id.orig_h as "Source", id.resp_h as "Server", flag as "Flag", count as "Requests", methods as "Methods", user_agents as "User Agents"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Flag">
          <colorPalette type="map">{"Suspicious UA":#F1813F,"Server Error":#DC4E41,"Client Error":#F8BE34,"Other":#708794}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 11: TLS/SSL Certificate Anomalies + File Transfers -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>TLS Certificate Anomalies</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:ssl
| where (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (id.resp_h LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| eval cert_fp=mvindex('cert_chain_fps{}', 0)
| where isnotnull(cert_fp)
| join type=left cert_fp [
    search index=network sourcetype=zeek:x509
    | rename fingerprint as cert_fp
    | fields cert_fp, certificate.subject, certificate.issuer, certificate.not_valid_before, certificate.not_valid_after
]
| eval flag=case(
    certificate.subject==certificate.issuer, "Self-Signed",
    certificate.not_valid_after &lt; now(), "Expired",
    (certificate.not_valid_after - certificate.not_valid_before) &gt; 94608000, "Long Validity (&gt;3yr)",
    validation_status!="ok" AND isnotnull(validation_status), "Validation Failed",
    1=1, "OK"
)
| where flag!="OK"
| eval not_before=strftime(certificate.not_valid_before, "%Y-%m-%d"), not_after=strftime(certificate.not_valid_after, "%Y-%m-%d")
| table _time, id.orig_h, id.resp_h, id.resp_p, server_name, certificate.subject, certificate.issuer, flag, validation_status, not_before, not_after
| sort -_time
| rename id.orig_h as "Source", id.resp_h as "Dest", id.resp_p as "Port", server_name as "Server Name", certificate.subject as "Subject", certificate.issuer as "Issuer", flag as "Flag", validation_status as "Validation", not_before as "Valid From", not_after as "Valid Until"
| head 30
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Flag">
          <colorPalette type="map">{"Self-Signed":#DC4E41,"Expired":#DC4E41,"Long Validity (&gt;3yr)":#F1813F,"Validation Failed":#F8BE34}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>Suspicious File Transfers</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:files
| where mime_type IN ("application/x-dosexec", "application/x-executable", "application/x-elf", "application/x-shellscript", "application/x-mach-o-executable", "application/java-archive", "application/x-archive", "application/zip", "application/x-rar", "application/x-7z-compressed", "application/x-bat", "application/vnd.ms-cab-compressed", "text/x-python", "text/x-perl", "text/x-shellscript")
| rename tx_hosts{} as tx_hosts, rx_hosts{} as rx_hosts
| eval source=mvindex(tx_hosts, 0), dest=mvindex(rx_hosts, 0)
| where (source LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (dest LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| eval size_KB=round(total_bytes/1024, 1)
| table _time, source, dest, filename, mime_type, size_KB, seen_bytes, md5, sha1
| sort -_time
| rename source as "Source", dest as "Dest", filename as "Filename", mime_type as "MIME Type", size_KB as "Size (KB)", seen_bytes as "Seen Bytes", md5 as "MD5", sha1 as "SHA1"
| head 30
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="MIME Type">
          <colorPalette type="map">{"application/x-dosexec":#DC4E41,"application/x-executable":#DC4E41,"application/x-elf":#DC4E41,"application/x-shellscript":#F1813F,"application/x-mach-o-executable":#DC4E41,"application/java-archive":#F1813F,"application/zip":#F8BE34,"application/x-rar":#F8BE34}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 12: SSH Network Activity + SMB Lateral Movement -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>SSH Activity Overview</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:ssh
| where (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (id.resp_h LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| eval status=if(auth_success=="true", "Success", "Failed")
| table _time, id.orig_h, id.resp_h, id.resp_p, client, server, status, direction, hassh, hassh_server
| sort -_time
| rename id.orig_h as "Source", id.resp_h as "Dest", id.resp_p as "Port", client as "Client Version", server as "Server Version", status as "Auth Status", direction as "Direction", hassh as "HASSH", hassh_server as "HASSH Server"
| head 50
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Auth Status">
          <colorPalette type="map">{"Success":#53A051,"Failed":#DC4E41}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>SMB Activity</title>
      <table>
        <search>
          <query>
index=network (sourcetype=zeek:smb_mapping OR sourcetype=zeek:smb_files)
| where (id.orig_h LIKE replace("$src_filter$", "\*", "%") OR "$src_filter$"="*") AND (id.resp_h LIKE replace("$dest_filter$", "\*", "%") OR "$dest_filter$"="*")
| eval activity=case(
    sourcetype=="zeek:smb_mapping", "Share Access",
    sourcetype=="zeek:smb_files", "File Operation",
    1=1, "Other"
)
| eval detail=coalesce(path, name, share_type)
| eval action_info=coalesce(action, "-")
| table _time, id.orig_h, id.resp_h, activity, share_type, detail, action_info
| sort -_time
| rename id.orig_h as "Source", id.resp_h as "Dest", activity as "Activity", share_type as "Share Type", detail as "Path/Name", action_info as "Action"
| head 50
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Activity">
          <colorPalette type="map">{"Share Access":#F1813F,"File Operation":#F8BE34}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
</form>
