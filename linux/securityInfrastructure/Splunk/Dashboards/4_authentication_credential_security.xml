<form version="1.1">
  <label>Authentication &amp; Credential Security</label>
  <description>Complete auth visibility - brute force, sudo, Kerberos, VPN, honeypot credential harvesting, Fail2Ban</description>

  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_token">
      <label>Time Range</label>
      <default>
        <earliest>-4h@m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="text" token="username_filter">
      <label>Username Filter</label>
      <default>*</default>
    </input>
  </fieldset>

  <!-- ============================================================ -->
  <!-- Row 1: 5 KPI Cards -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <single>
        <title>Linux Failed Auth</title>
        <search>
          <query>
index=linux sourcetype=linux_secure "Failed password"
| stats count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[50,500]</option>
        <option name="underLabel">SSH/PAM Failures</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Windows Failed Auth</title>
        <search>
          <query>
index=windows sourcetype="WinEventLog:Security" EventCode=4625
| stats count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[50,500]</option>
        <option name="underLabel">Event 4625</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Successful Logins</title>
        <search>
          <query>
(index=linux sourcetype=linux_secure "Accepted") OR
(index=windows sourcetype="WinEventLog:Security" EventCode=4624 Logon_Type IN (2,3,7,10))
| stats count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">All Sources</option>
        <option name="useColors">0</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Brute Force Sources</title>
        <search>
          <query>
(index=linux sourcetype=linux_secure "Failed password") OR
(index=windows sourcetype="WinEventLog:Security" EventCode=4625)
| rex field=_raw "from\s+(?&lt;attacker_ip&gt;\d+\.\d+\.\d+\.\d+)"
| eval attacker_ip=coalesce(attacker_ip, IpAddress, src_ip)
| stats count as failures by attacker_ip
| where failures &gt; 10
| stats count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[0,5]</option>
        <option name="underLabel">IPs with 10+ Failures</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Fail2Ban Actions</title>
        <search>
          <query>
index=linux sourcetype=fail2ban ("Ban" OR "Unban")
| stats count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Ban/Unban Events</option>
        <option name="useColors">0</option>
      </single>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 2: Failed Auth Timeline + Brute Force to Success -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Failed Authentication Timeline</title>
      <chart>
        <search>
          <query>
(index=linux sourcetype=linux_secure "Failed password") OR
(index=windows sourcetype="WinEventLog:Security" EventCode=4625) OR
(index=linux sourcetype=cowrie eventid="cowrie.login.failed")
| eval auth_source=case(
    sourcetype=="linux_secure", "Linux SSH/PAM",
    sourcetype=="WinEventLog:Security", "Windows",
    sourcetype=="cowrie", "Honeypot",
    1=1, "Other"
)
| timechart span=5m count by auth_source
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.fieldColors">{"Linux SSH/PAM":#F1813F,"Windows":#006D9C,"Honeypot":#DC4E41}</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Brute Force to Success Chains</title>
      <table>
        <search>
          <query>
index=linux sourcetype=linux_secure ("Failed password" OR "Accepted")
| rex field=_raw "(?:Failed password|Accepted\s+\w+)\s+for\s+(?:invalid user\s+)?(?&lt;target_user&gt;\S+)\s+from\s+(?&lt;attacker_ip&gt;\d+\.\d+\.\d+\.\d+)"
| where isnotnull(attacker_ip)
| eval event_type=if(match(_raw, "Accepted"), "success", "failure")
| stats count(eval(event_type="failure")) as failures, count(eval(event_type="success")) as successes, min(_time) as first_attempt, max(_time) as last_event by attacker_ip, target_user
| where failures &gt; 5 AND successes &gt; 0
| eval duration_min=round((last_event-first_attempt)/60, 1)
| eval first_attempt=strftime(first_attempt, "%H:%M:%S"), last_event=strftime(last_event, "%H:%M:%S")
| sort -failures
| rename attacker_ip as "Attacker IP", target_user as "User", failures as "Failures", successes as "Successes", duration_min as "Duration (min)"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Successes">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#DC4E41"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 3: Top Failed Auth by IP + Successful Auth by IP -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Top Failed Auth by Source IP</title>
      <table>
        <search>
          <query>
(index=linux sourcetype=linux_secure "Failed password") OR
(index=windows sourcetype="WinEventLog:Security" EventCode=4625)
| rex field=_raw "from\s+(?&lt;attacker_ip&gt;\d+\.\d+\.\d+\.\d+)"
| eval attacker_ip=coalesce(attacker_ip, IpAddress, src_ip)
| rex field=_raw "for\s+(?:invalid user\s+)?(?&lt;target_user&gt;\S+)"
| eval target_user=coalesce(target_user, TargetUserName, user)
| stats count as failures, dc(target_user) as unique_users, dc(host) as unique_targets, values(target_user) as users_tried by attacker_ip
| sort -failures
| rename attacker_ip as "Source IP", failures as "Failures", unique_users as "Unique Users", unique_targets as "Unique Hosts", users_tried as "Users Tried"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Failures">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#F8BE34"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Successful Auth by Source IP</title>
      <table>
        <search>
          <query>
(index=linux sourcetype=linux_secure "Accepted") OR
(index=windows sourcetype="WinEventLog:Security" EventCode=4624 Logon_Type IN (2,3,7,10))
| rex field=_raw "for\s+(?&lt;login_user&gt;\S+)\s+from\s+(?&lt;src_ip&gt;\d+\.\d+\.\d+\.\d+)"
| eval src_ip=coalesce(src_ip, IpAddress), login_user=coalesce(login_user, TargetUserName)
| where isnotnull(src_ip)
| stats count as logins, values(login_user) as users, dc(host) as unique_hosts by src_ip
| sort -logins
| rename src_ip as "Source IP", logins as "Logins", users as "Users", unique_hosts as "Hosts"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 4: Sudo Activity + User/Group Changes -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Sudo Activity</title>
      <table>
        <search>
          <query>
index=linux sourcetype=linux_secure "sudo:" NOT "pam_unix"
| rex field=_raw "sudo:\s+(?&lt;sudo_user&gt;\S+)\s+:\s+.*USER=(?&lt;target_user&gt;\S+)\s+.*COMMAND=(?&lt;command&gt;.+)"
| where isnotnull(sudo_user) AND (sudo_user LIKE "$username_filter$" OR "$username_filter$"="*")
| table _time, host, sudo_user, target_user, command
| sort -_time
| rename sudo_user as "User", target_user as "Run As", command as "Command"
| head 50
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
    <panel>
      <title>User / Group Changes</title>
      <table>
        <search>
          <query>
(index=linux sourcetype=linux_secure ("useradd" OR "usermod" OR "userdel" OR "groupadd" OR "groupmod" OR "groupdel" OR "passwd"))
OR (index=windows sourcetype="WinEventLog:Security" EventCode IN (4720,4722,4724,4725,4726,4728,4732,4733,4756))
| eval action=case(
    match(_raw, "useradd"), "User Created",
    match(_raw, "userdel"), "User Deleted",
    match(_raw, "usermod"), "User Modified",
    match(_raw, "groupadd"), "Group Created",
    match(_raw, "groupdel"), "Group Deleted",
    match(_raw, "groupmod"), "Group Modified",
    match(_raw, "passwd"), "Password Changed",
    EventCode=="4720", "Win User Created",
    EventCode=="4726", "Win User Deleted",
    EventCode=="4724", "Win Password Reset",
    EventCode=="4722", "Win User Enabled",
    EventCode=="4725", "Win User Disabled",
    EventCode=="4728", "Win Group Member Added (Global)",
    EventCode=="4732", "Win Group Member Added (Local)",
    EventCode=="4733", "Win Group Member Removed",
    EventCode=="4756", "Win Group Member Added (Universal)",
    1=1, "Other"
)
| table _time, host, action, _raw
| eval detail=substr(_raw, 1, 150)
| fields _time, host, action, detail
| sort -_time
| rename action as "Action", detail as "Details"
| head 30
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Action">
          <colorPalette type="map">{"User Created":#F1813F,"User Deleted":#DC4E41,"Password Changed":#F8BE34,"Win User Created":#F1813F,"Win User Deleted":#DC4E41,"Win Password Reset":#F8BE34,"Win Group Member Added (Global)":#F1813F,"Win Group Member Added (Local)":#F1813F}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 5: Kerberoasting Timeline + Kerberos Traffic -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Kerberoasting / ASREP Timeline</title>
      <chart>
        <search>
          <query>
(index=network sourcetype=zeek:notice note IN ("Kerberoasting_Detected", "ASREP_Roasting")) OR
(index=windows sourcetype="WinEventLog:Security" EventCode=4769 Ticket_Encryption_Type=0x17)
| eval attack=case(
    note=="Kerberoasting_Detected", "Kerberoasting (Zeek)",
    note=="ASREP_Roasting", "AS-REP Roasting (Zeek)",
    EventCode=="4769", "TGS Request RC4 (Win)",
    1=1, "Other"
)
| timechart span=5m count by attack
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Kerberos Traffic</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:kerberos
| stats count as requests, dc(service) as unique_services, values(service) as services by client, request_type
| sort -requests
| rename client as "Client Principal", request_type as "Request Type", requests as "Requests", unique_services as "Unique Services", services as "Services"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 6: VPN/Remote Access + SSH Auth Results -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>VPN / Remote Access Sessions</title>
      <table>
        <search>
          <query>
(index=linux sourcetype=openvpn) OR
(index=linux sourcetype="ipsec:charon") OR
(index=linux sourcetype=linux_secure "sshd" ("Accepted" OR "Failed"))
| eval session_type=case(
    sourcetype=="openvpn", "OpenVPN",
    sourcetype=="ipsec:charon", "IPSec",
    sourcetype=="linux_secure", "SSH",
    1=1, sourcetype
)
| eval status=case(
    match(_raw, "Accepted|established|connected"), "Connected",
    match(_raw, "Failed|denied|rejected"), "Failed",
    match(_raw, "closed|disconnected|terminated"), "Disconnected",
    1=1, "Other"
)
| table _time, host, session_type, status, _raw
| eval detail=substr(_raw, 1, 150)
| fields _time, host, session_type, status, detail
| sort -_time
| rename session_type as "Type", status as "Status", detail as "Details"
| head 30
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"Connected":#53A051,"Failed":#DC4E41,"Disconnected":#708794,"Other":#F8BE34}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>Zeek SSH Auth Results</title>
      <table>
        <search>
          <query>
index=network sourcetype=zeek:ssh
| stats count as attempts, count(eval(auth_success=="T" OR auth_success=="true")) as successes, count(eval(auth_success=="F" OR auth_success=="false")) as failures by id.orig_h, id.resp_h
| eval success_rate=round(successes*100/(successes+failures), 1)
| sort -attempts
| rename id.orig_h as "Source", id.resp_h as "Destination", attempts as "Attempts", successes as "Successes", failures as "Failures", success_rate as "Success %"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Success %">
          <colorPalette type="minMidMax" maxColor="#53A051" midColor="#F8BE34" minColor="#DC4E41"></colorPalette>
          <scale type="minMidMax" minValue="0" maxValue="100"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 7: Cowrie Credential Harvesting + Command Replay -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Cowrie Credential Harvesting</title>
      <table>
        <search>
          <query>
index=linux sourcetype=cowrie eventid IN ("cowrie.login.failed", "cowrie.login.success")
| spath
| stats count as attempts, count(eval(eventid=="cowrie.login.success")) as successes by username, password
| sort -attempts
| rename username as "Username", password as "Password", attempts as "Attempts", successes as "Successes"
| head 30
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Successes">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#53A051"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Cowrie Command Replay</title>
      <table>
        <search>
          <query>
index=linux sourcetype=cowrie eventid="cowrie.command.input"
| spath
| table _time, src_ip, input
| sort -_time
| rename src_ip as "Attacker", input as "Command"
| head 50
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>

  <!-- ============================================================ -->
  <!-- Row 8: Fail2Ban Timeline -->
  <!-- ============================================================ -->
  <row>
    <panel>
      <title>Fail2Ban Ban/Unban Timeline</title>
      <chart>
        <search>
          <query>
index=linux sourcetype=fail2ban ("Ban" OR "Unban")
| eval action=case(
    match(_raw, "Ban"), "Ban",
    match(_raw, "Unban"), "Unban",
    1=1, "Other"
)
| timechart span=5m count by action
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>60</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.fieldColors">{"Ban":#DC4E41,"Unban":#53A051}</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
</form>
